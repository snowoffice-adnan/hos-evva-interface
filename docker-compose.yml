version: "3.9"

services:
  evva-interface:
    build:
      context: .
      dockerfile: Dockerfile
    image: evva-interface:latest

    # Map container port -> host port
    ports:
      - "3000:3000"

    # Load environment from external file (e.g. .env.evva)
    env_file:
      - ${ENV_FILE}

    # Mount certs into the container at /run/certs (read-only)
    volumes:
      - ${CERTS_DIR}:/run/certs:ro

    # Security hardening
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    restart: unless-stopped

    healthcheck:
      test: [
        "CMD-SHELL",
        "wget -qO- http://127.0.0.1:${PORT:-3000}/${API_PREFIX:-api/v1}/integrations/evva/xs3/reader-state >/dev/null 2>&1 || exit 1"
      ]
      interval: 30s
      timeout: 3s
      start_period: 30s
      retries: 3
